<!DOCTYPE html>
<html lang="ja">

<head>
 <meta charset="UTF-8">
 <title>独自ドメイン設定後にリダイレクト機能を追加する</title>
 <meta name="viewport" content="width=device-width, initial-scale=1.0">
 <meta name="description" content="PythonのFlaskを使ってリダイレクト機能を実装する方法をお伝えします。">
 <meta name="keywords" content="Python, Flask, 個人サイト制作">
 <meta name="robots" content="index, follow">
 <meta property="og:title" content="独自ドメイン設定後にリダイレクト機能を追加する">
 <meta property="og:description" content="PythonのFlaskを使ってリダイレクト機能を実装する方法をお伝えします。">
 <meta property="og:image" content="{{ url_for('static', filename='images/anafish.png') }}">
 <meta property="og:url" content="https://feinatelier.org/redirect">
 <link rel="manifest" href="{{ url_for('static', filename='manifest.json') }}">

 <!-- 構造化データ -->
 <script type="application/ld+json">
    {
      "@context": "https://schema.org",
      "@type": "Organization",
      "name": "独自ドメイン設定後にリダイレクト機能を追加する",
      "url": "https://feinatelier.org/server/redirect.html",
      "logo": "https://feinatelier.org/static/images/barracuda.jpg"
    }
    </script>

 <!-- CSSファイル -->
 <link rel="stylesheet" type="text/css" href="{{ url_for('static', filename='css/pstyle.css') }}">
 <link rel="stylesheet" type="text/css" href="{{ url_for('static', filename='css/style.css') }}">
 <link rel="stylesheet" type="text/css" href="{{ url_for('static', filename='css/header.css') }}">
 <link rel="stylesheet" type="text/css" href="{{ url_for('static', filename='css/footer.css') }}">
 <link rel="stylesheet" type="text/css" href="{{ url_for('static', filename='css/flower.css') }}">
 <link rel="stylesheet" type="text/css" href="{{ url_for('static', filename='css/menu.css') }}">
 <link rel="stylesheet" type="text/css" href="{{ url_for('static', filename='css/collapsible.css') }}">
 <link rel="stylesheet" type="text/css" href="{{ url_for('static', filename='css/feinpan.css') }}">
 <link rel="stylesheet" type="text/css" href="{{ url_for('static', filename='css/feinheadline1.css') }}">
 <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.25.0/themes/prism-tomorrow.min.css">

 <link rel="preconnect" href="https://fonts.googleapis.com">
 <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
 <link
  href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@100..900&family=Lato:ital,wght@0,100;0,300;0,400;0,700;0,900;1,100;1,300;1,400;1,700;1,900&display=swap"
  rel="stylesheet">
 <link rel="apple-touch-icon" sizes="180x180" href="{{ url_for('static', filename='icons/appleicon.png') }}">
 <link rel="icon" sizes="32x32" href="{{ url_for('static', filename='icons/favicon.ico') }}" type="image/x-icon">

 <!-- Googleタグマネージャー -->
 <script async src="https://www.googletagmanager.com/gtag/js?id=G-827JM6N5CS"></script>
 <script>
  window.dataLayer = window.dataLayer || [];
  function gtag() { dataLayer.push(arguments); }
  gtag('js', new Date());
  gtag('config', 'G-827JM6N5CS');
 </script>

 <!-- Microsoftタグ -->
 <script>
  (function (c, l, a, r, i, t, y) {
   c[a] = c[a] || function () { (c[a].q = c[a].q || []).push(arguments) };
   t = l.createElement(r); t.async = 1; t.src = "https://www.clarity.ms/tag/" + i;
   y = l.getElementsByTagName(r)[0]; y.parentNode.insertBefore(t, y);
  })(window, document, "clarity", "script", "obazqypsh8");
 </script>

 <!-- JavaScriptファイル -->
 <script src="{{ url_for('static', filename='js/underline.js') }}"></script>
 <script src="{{ url_for('static', filename='js/feinfade.js') }}"></script>
 <script src="{{ url_for('static', filename='js/feinScroll.js') }}"></script>
 <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.6.347/pdf.min.js"></script>
 <script src="{{ url_for('static', filename='js/album.js') }}"></script>

 <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.25.0/prism.min.js"></script>
 <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.25.0/components/prism-python.min.js"></script>
 <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.25.0/components/prism-bash.min.js"></script>
 <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.25.0/components/prism-json.min.js"></script>
 <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.25.0/components/prism-yaml.min.js"></script>
 <script src="{{ url_for('static', filename='js/collapsible.js') }}"></script>

 <!-- Service Workerの登録 -->
 <script>
  if ('serviceWorker' in navigator) {
   navigator.serviceWorker.register('/service-worker.js')
    .then(registration => {
     console.log('ServiceWorker registration successful with scope: ', registration.scope);
    })
    .catch(error => {
     console.log('ServiceWorker registration failed: ', error);
    });
  }
 </script>
</head>

<body>

 <nav class="den_nav">
  <ul>
   <li><a href="https://feinatelier.org/"><img src="/menu/mspass.png" alt="このサイトのシンボルマーク" class="feinhome"></a></li>
   <li><a href="/" class="animated-link">ホーム</a></li>
   <li><a href="/another-eden/anaden_sitemap.html" class="animated-link">アナザーエデン</a></li>
   <li><a href="/fish/fish_sitemap.html" class="animated-link">アウトドアのエリア</a></li>
   <li><a href="/contents/site_create.html" class="animated-link">個人サイト制作</a></li>
   <li><a href="/contents/protect.html" class="animated-link">AI学習を防ぐ工夫</a></li>
   <li><a href="/contents/rss.html" class="animated-link">更新のお知らせ</a></li>
  </ul>
 </nav>

 <!--レスポンシブデザイン-->
 <div class="feincontainer">


  <!--パンくずリスト-->
  <div>
   <ol class="breadcrumb">
    <li class="breadcrumb-item"><a href="/">Home（グラスタの場所一覧表〜入手範囲別〜）</a></li>
    <li class="breadcrumb-item"><a href="/contents/site_create.html">個人サイト制作：サイトマップ</a></li>
    <li class="breadcrumb-item active" aria-current="page">独自ドメイン設定後にリダイレクト機能を追加する</li>
   </ol>
  </div>



  <!-- ハンバーガーメニュー -->
  <div class="fden-hamburger-menu">
   <button class="fden-hamburger-button" id="fden-hamburger-button" onclick="toggleMenu()">☰ メニューを開く
    ▼</button>
   <div class="fden-menu" id="fden-menu">
    <!-- メニュー内容は外部ファイルから読み込む -->
    <div id="fden-menu-content"></div>
   </div>
  </div>
  <script src="{{ url_for('static', filename='js/menu.js') }}"></script>
  <!-- ハンバーガーメニューここまで -->

  <!--サイトタイトル-->
  <div class="header-frame">
   <div class="header-container">
    <img src="{{ url_for('static', filename='images/VisualAtelierCode.png') }}" alt="Fein Atelier - org"
     class="header-image">
    <div class="header-text">
     <a href="https://feinatelier.org/">Fein Atelier - org</a>
    </div>
   </div>
  </div>

  <div class="spacer"></div>

  <button id="generate-headings" data-open-text="独自ドメイン設定後にリダイレクト機能を追加するの目次を開く ▼"
   data-close-text="独自ドメイン設定後にリダイレクト機能を追加するの目次を閉じる ▲">独自ドメイン設定後にリダイレクト機能を追加するの目次を開く ▼</button><!--目次の自動生成-->
  <div class="spacer"></div>

  <p><a href="/contents/site_create.html">個人サイト制作：サイトマップへ戻る</a></p>

  <!-- ●ヘッダーここまで。直下でコンテンツ開始● -->
  <h1 class="background-waveimage-heading"><span>独自ドメイン設定後にリダイレクト機能を追加する</span></h1>

  <p>このコードはFlaskの機能を使っており、サーバーサイドスクリプトに該当します。<br>
   次のように動作するリダイレクト機能を実装する方法を、このページには書いていきます。<br>
   <a href="/contents/domain.html">注意したい独自ドメイン設定手順とルール</a>の続きとも言えますね。
  </p>

  <dl>
   <dt>1. <strong>Flaskモジュールの使用</strong>:</dt>
   <dd>
    <span class="codecolor">Flask</span>クラスをインスタンス化して<span class="codecolor">app</span>として使用しています。<br>
    Flaskはサーバーサイドフレームワークなので、このコードはサーバーサイドスクリプトです。
   </dd>

   <dt>2. <strong>ルーティング（<span class="codecolor">@app.route()</span>）</strong>:</dt>
   <dd>
    URLのルーティングを設定し、クライアントからのリクエストを処理しています。<br>
    この場合、すべてのURLリクエストをキャッチし、リダイレクト処理へ渡しています。
   </dd>

   <dt>3. <strong><span class="codecolor">redirect</span>関数</strong>:</dt>
   <dd>
    サーバー側で新しいURLにリクエストをリダイレクトしています。<br>
    <span class="codecolor">redirect</span>はFlaskの標準的なサーバーサイド処理の一部です。
   </dd>

   <dt>4. <strong><span class="codecolor">request</span>オブジェクト</strong>:</dt>
   <dd>
    クライアントからのHTTPリクエスト情報を取得し、リクエストURLを基に新しいURLを構築しています。
   </dd>
  </dl>

  <p>このコードの構成を見ると、典型的なサーバーサイドスクリプトと言えます。<br>
   リクエストされたURLを動的に書き換え、新しいURLにリダイレクトする処理を行っていますし、実行はサーバー上で行われ、クライアント（ユーザーのブラウザ）にはリダイレクト先のURLだけが通知されます。</p>

  <h2>App Engineのリダイレクト設定</h2>
  <p>リダイレクト設定を自分で行うなら、自身のサイトの構造を知る必要があります。<br>
   このような構造は一般的に「プロジェクト構成」や「ディレクトリ構造」と呼ばれます。<br>
   私の場合、Google App Engineにデプロイされていて、動的Webサイト（Flask使用）と静的Webサイトが混在しているのが特徴となっています。</p>

  <div class="code-container">
   <pre><code class="feintyping language-txt">
GOOGLE CLOUD\FEIN-SITES-DEV1(app engineにデプロイされているFlaskアプリ、https://feinatelier.org/)
├─static
│  ├─css
│  ├─externalization
│  ├─flower1
│  ├─icons
│  ├─images
│  ├─js
│  ├─menu
│  └─nature
├─templates
│  │  top.html（動的Webサイトのトップページ）
│   ▲上側がFlaskフレームワーク。サーバーサイドスクリプトを活用した動的Webサイトです。
│   ▼下側が普通のホームぺージ。フロントエンド3言語による静的Webサイトです。
├─www
│  │  favicon.ico
│  │  index.html（静的Webサイトのトップページ）
│  │  manifest.json
│  │  robots.txt
│  │  service-worker.js
│  ├─another-eden
│  │  ├─anaimage
│  │  │  ├─goods
│  │  │  ├─heavenburnsred
│  │  │  ├─oldanaden
│  │  │  ├─spoiler
│  │  │  └─vcgrasta
│  │  ├─fein_report
│  │  └─icon
│  ├─contents
│  │  ├─itimages
│  │  │  ├─cat_a
│  │  │  ├─cat_b
│  │  │  ├─feinne
│  │  │  ├─metainput
│  │  │  ├─picture_1hide
│  │  │  ├─picture_allhide
│  │  │  │  └─afterhide
│  │  │  └─pwainfo
│  ├─css
│  ├─externalization
│  ├─fish
│  ├─fleur1
│  ├─flower1
│  ├─flower2
│  ├─flower3
│  ├─icons
│  ├─image
│  ├─menu
│  ├─paint
│  ├─rss
│  ├─script
│  ├─sea
│  └─video

</code></pre>
  </div>

  <p>この構造は、「Webアプリケーションを動かすためのファイルやフォルダを整理した箱」と考えると分かりやすいです。<br>
   それぞれの部分に役割があり、全体が一緒になって動きます。</p>

  <h3>1. メインサービス（上側部分）</h3>
  <p>この部分は、サーバー側（バックエンド）で動く頭脳のようなものです。<br>
   サーバーが「お客さん（訪問者）のリクエスト」を受け取ったり、必要な情報を探して返す役割を持ちます。</p>
  <dl>
   <dt>main.py</dt>
   <dd>サーバーの中核部分。<br>
    お客さんが「/aboutページ見せて」と頼んだら、それに応じる処理を書く。</dd>

   <dt>app.yaml</dt>
   <dd>サーバーの設定を記述。<br>
    「どう動くのか」「どの言語（Python）で動かすか」を教える説明書。</dd>

   <dt>templates/</dt>
   <dd>見た目（HTML）を動的に生成するファイルの置き場所。</dd>
  </dl>

  <h3>2. リダイレクト専用サービス</h3>
  <p>このセクションで集中的に見ていくエリアです。<br>
   リダイレクトとは、「訪問者を自動で別のページに連れて行く」仕組みです。<br>
   例えば、「古いページに来た人を新しいページに案内」するときなどに使います。</p>
  <p>私の場合、他のエリアと同じようにPythonで書かれた小さな追加サービスとなっています。<br>
   別のサーバーでも動かせるよう、ファイルが独立しています。</p>

  <h3>3. 静的ファイル（下側部分）</h3>
  <p>静的ファイルは、「サーバー側で処理がいらない見た目のページや素材」の集まりです。単純にブラウザで読まれるだけの部分ですよね。<br>
   何かしらの紹介ページ（HTMLファイル）や、デザインの色や形を決めるCSSファイル、ボタンの動きを制御するJavaScriptファイルなどがあります。</p>

  <dl>
   <dt>css/</dt>
   <dd>ページのデザインや色、フォントを決めるファイル。</dd>

   <dt>script/</dt>
   <dd>ページ上で動くプログラムを置く場所（例えば、ボタンをクリックしたときに動く仕組み）。</dd>

   <dt>favicon.ico</dt>
   <dd>ブラウザのタブに表示される小さいアイコン。</dd>
  </dl>

  <h3>プロジェクト構成の全体像</h3>
  <ol>
   <li>サーバーが訪問者のリクエストを受け取る（例えば、「トップページを見たい」）。</li>
   <li>サーバーが「バックエンド（動的部分）」でそのリクエストを処理する。</li>
   <li>必要に応じて「静的ファイル」を利用しながら、最終的なページを作成して訪問者のブラウザに返す。</li>
  </ol>

  <p>この構造の強みは、「動的な処理」と「静的な素材」をうまく組み合わせて使える点です。<br>
   簡単にいうと、「頭を使って動く部分」（サーバー処理）と、「見た目を支える部分」（静的ファイル）が一緒に整理されていて、効率よく作業できるようになっています。</p>
  <p>では、リダイレクト設定を行うソースコードを見ていきます。</p>

  <p class="codegra" id="redirect_python">リダイレクト設定を行うredirect.py</p>
  <div class="code-container">
   <pre><code class="feintyping language-python">
import os
from flask import Flask, request, redirect

app = Flask(__name__)

@app.route('/', defaults={'path': ''})
@app.route('/&lt;path:path&gt;')
def redirect_all(path):
    # クエリ文字列も含めた完全な URL を作成
    new_url = request.url.replace(request.host, 'feinatelier.org', 1)
    return redirect(new_url, code=301)

if __name__ == '__main__':
    port = int(os.environ.get('PORT', 8080))
    debug_mode = os.getenv('FLASK_DEBUG', 'False').lower() == 'true'  # デバッグモードを環境変数で制御
    app.run(host='0.0.0.0', port=port, debug=debug_mode)

</code></pre>
  </div>
  <p>このコードを動かすと、例えば「http://example.com/some-page」にアクセスした人を自動的に「http://feinatelier.org/some-page」に転送してくれる、という仕組みです。</p>

  <ol>
   <li>ユーザーがリクエスト（ページにアクセス）。</li>
   <li>Flaskアプリがそのリクエストを受け取る。</li>
   <li>新しいURLを作成し、ユーザーをそこに転送。</li>
  </ol>

  <p>コードの部分ごとの説明をしていきます。</p>

  <p><strong>ライブラリの読み込み</strong></p>
  <div class="code-container">
   <pre><code class="feintyping language-python">
import os
from flask import Flask, request, redirect

</code></pre>
  </div>
  <dl>
   <dt>import os</dt>
   <dd>環境変数やシステム関連の情報を扱うための標準モジュールです。</dd>

   <dt>from flask import ...</dt>
   <dd>FlaskはPythonでWebアプリを作るためのフレームワーク（便利ツールセット）です。<br>
    このコードではその一部の機能を使っています。</dd>

   <dt>Flask</dt>
   <dd>Webアプリの土台を作るためのクラス。</dd>

   <dt>request</dt>
   <dd>ユーザーのアクセス情報（URLやリクエスト内容など）を取得するために使用します。</dd>

   <dt>redirect</dt>
   <dd>別のURLに転送するための便利な関数です。</dd>
  </dl>

  <p><strong>Flaskアプリの初期化</strong></p>
  <div class="code-container">
   <pre><code class="feintyping language-python">
app = Flask(__name__)

</code></pre>
  </div>

  <dl>
   <dt>役割</dt>
   <dd>この一行でアプリケーションの土台を作成します。<br>
    「Flaskを使ってアプリを動かしますよー」という合図のようなものです。</dd>
  </dl>

  <p><strong>リダイレクトのルート設定</strong></p>
  <div class="code-container">
   <pre><code class="feintyping language-python">
@app.route('/', defaults={'path': ''})
@app.route('/&lt;path:path&gt;')
 def redirect_all(path):

</code></pre>
  </div>
  <dl>
   <dt>@app.route(...)</dt>
   <dd>訪問者がどのURL（パス）にアクセスしても、この関数が実行されるよう設定しています。</dd>

   <dt>/</dt>
   <dd>ルートパス（トップページ）用の設定。</dd>

   <dt>&lt;path:path&gt;</dt>
   <dd>任意のパス（例: /about や /contact）に対応します。</dd>
  </dl>

  <p><strong>関数の中身</strong></p>
  <div class="code-container">
   <pre><code class="feintyping language-python">
new_url = request.url.replace(request.host, 'feinatelier.org', 1)
return redirect(new_url, code=301)

</code></pre>
  </div>
  <dl>
   <dt>request.url</dt>
   <dd>ユーザーがアクセスした元のURLを取得します。</dd>

   <dt>.replace(request.host, 'feinatelier.org', 1)</dt>
   <dd>URLの中のホスト名（<span class="codecolor">request.host</span> = 現在のドメイン）を、<span
     class="codecolor">feinatelier.org</span>に置き換えます。</dd>

   <dt>redirect(...)</dt>
   <dd>作成した新しいURLに転送します。</dd>

   <dt>code=301</dt>
   <dd>HTTPステータスコードで「恒久的なリダイレクト」を意味します。</dd>
  </dl>

  <p><strong>アプリの起動</strong></p>
  <div class="code-container">
   <pre><code class="feintyping language-python">
if __name__ == '__main__':
port = int(os.environ.get('PORT', 8080))
debug_mode = os.getenv('FLASK_DEBUG', 'False').lower() == 'true'
app.run(host='0.0.0.0', port=port, debug=debug_mode)

</code></pre>
  </div>
  <dl>
   <dt>if __name__ == '__main__':</dt>
   <dd>このコードが直接実行されるときにだけ動く部分を指定しています。</dd>

   <dt>環境変数からポート番号とデバッグモードを取得</dt>
   <dd></dd>

   <dt>os.environ.get('PORT', 8080)</dt>
   <dd>環境変数からポート番号を取得。指定がない場合はデフォルトで8080番を使用します。</dd>

   <dt>os.getenv('FLASK_DEBUG', 'False').lower() == 'true'</dt>
   <dd>デバッグモードをON/OFFする設定。</dd>

   <dt>app.run(...)</dt>
   <dd>アプリケーションを起動します。</dd>
   <dd>host='0.0.0.0':<br>
    どのIPアドレスからのアクセスも受け付ける設定。</dd>
   <dd>port=port:<br>
    ここで設定されたポート番号を使います。</dd>
   <dd>debug=debug_mode:<br>
    デバッグモードを環境変数でON/OFFできます。</dd>
  </dl>

  <h5>リダイレクト実装方法の選択肢</h5>
  <p>私のプロジェクト構成の場合、次の2つの変更方法が考えられました。<br>
   どちらも「default URL → 独自ドメイン」へのリダイレクトを実現できます。</p>

  <dl>
   <dt>1. シンプルにコードで処理したい場合</dt>
   <dd>
    <span class="codecolor">main.py</span> に <span class="codecolor">@app.before_request</span> を追加してリダイレクト。<br>
    ただし、<span class="codecolor">app.yaml</span> の静的ハンドラは Flask 経由にならないため、すべてのリクエストに適用するには <span
     class="codecolor">app.yaml</span> の設定変更が必要でした。
   </dd>

   <dt>2. 静的ハンドラもそのまま活かしたい場合</dt>
   <dd>
    別途リダイレクト専用サービスを構築し、<span class="codecolor">dispatch.yaml</span> で default URL（<span
     class="codecolor">fein-sites-dev1.ew.r.appspot.com</span>）から振り分ける方法を採用する。
   </dd>
  </dl>

  <p>こういうときどちらの方法をとるかは、運用のしやすさで考えたほうが良いと思うんですよね。<br>
   どちらの方法でも「default URL から独自ドメインへの恒久リダイレクト (HTTP 301)」が実現できますが…<br>
   私は2.の静的ハンドラもそのまま活かす方を選択しています。<br>
   なぜ2.を選んだのかは、追って説明していきます。</p>


  <p class="codegra" id="redirect_dispatch">リダイレクト設定を行うdispatch.yaml</p>
  <div class="code-container">
   <pre><code class="feintyping language-yaml">
dispatch:
  - url: "fein-sites-dev1.ew.r.appspot.com/*"
    service: redirect-service

</code></pre>
  </div>

  <p>このファイルは、Google App Engineでアプリケーション内のトラフィックルーティングを設定するために使います。<br>
   「どのリクエスト（URL）をどのサービスに送るか」を決めるルールを書いているってことです。</p>

  <ol>
   <li>ユーザーが「<span class="codecolor">fein-sites-dev1.ew.r.appspot.com/</span>」にアクセスする。</li>
   <li><span class="codecolor">dispatch.yaml</span> を使って「このリクエストは <span class="codecolor">redirect-service</span>
    に送るべき」と判断する。</li>
   <li><span class="codecolor">redirect-service</span> が実行され、別のURL（例: <span
     class="codecolor">http://feinatelier.org</span>）にリダイレクトします。</li>
  </ol>

  <p><strong>1. dispatch:</strong><br>
   このファイルで「どのリクエストをどのサービスに送るか」という指示を開始します。</p>

  <p><strong>2. - url: "fein-sites-dev1.ew.r.appspot.com/*"</strong><br>
   ここでは、「すべてのURL（例: /about や /contact）」が含まれるこのドメイン（fein-sites-dev1.ew.r.appspot.com）に対するリクエストをキャッチします。</p>
  <dl>
   <dt>*</dt>
   <dd>これはワイルドカードと呼ばれ、「すべてのURLを含む」という意味です。</dd>

   <dt>例</dt>
   <dd>以下すべてのリクエストを対象にします。</dd>
   <dd>http://fein-sites-dev1.ew.r.appspot.com/</dd>
   <dd>http://fein-sites-dev1.ew.r.appspot.com/about</dd>
   <dd>http://fein-sites-dev1.ew.r.appspot.com/contact</dd>
  </dl>

  <p><strong>3. service: redirect-service</strong><br>
   上記のURLリクエストを redirect-service に送ります。<br>
   これはGoogle App Engine内で動作するサービスの名前で、リダイレクト処理を行うサービスを指します。</p>

  <p>このファイルは、Google App Engineの中でどの機能をどのリクエストに対応させるかを分ける「交通整理」の役割を持っています。<br>
   エラーが出るとすべてのリクエストが止まる可能性があるため、修正する際には注意が必要です。</p>

  <h5>App Engineで複数のサービスを構成する</h5>
  <p>App Engine では、複数のサービスを持つ場合、各サービスごとに独自の app.yaml を配置します。<br>
   つまりこのプロジェクト内に複数の app.yaml が存在する形になりますが、これは正常な構成です。<br>
   メインサービス用とリダイレクト専用のサービス用、2つの app.yaml が存在するわけです。</p>
  <p>また、プロジェクトルートに配置する dispatch.yaml によって、
   https://fein-sites-dev1.ew.r.appspot.com/ へのリクエストがリダイレクト用サービスに転送されるので、メインサービスの app.yaml に手を加える必要がないのです。</p>

  <p class="codegra" id="redirect_requirements">リダイレクト設定に使うrequirements.txt</p>
  <div class="code-container">
   <pre><code class="feintyping language-txt">
Flask==2.3.2
gunicorn==20.1.0

</code></pre>
  </div>

  <p>このファイルは、Pythonで作られたアプリケーションに必要なライブラリやツールの一覧を記載したものです。<br>
   アプリケーションを動かす際に、「どのバージョンのライブラリが必要なのか」を指定します。</p>

  <ol>
   <li>この<span class="codecolor">requirements.txt</span>を使って必要なライブラリをインストールします（<span class="codecolor">pip install -r
     requirements.txt</span>）。</li>
   <li>FlaskはWebアプリを動かすためのコードを書く部分をサポート。</li>
   <li>Gunicornは、そのアプリを外部（訪問者）からアクセスできる形で動作させます。</li>
  </ol>

  <p>ここではPythonのWebフレームワークのFlask==2.3.2を使うよう指定しています。<br>
   FlaskはWebアプリを作るためのツールセットです。<br>
   例えば、リクエストを受け取ってレスポンスを返す機能や、HTMLを動的に作る機能を提供します。</p>

  <p>同様に、ここではPythonのHTTPサーバーのgunicorn==20.1.0を使います。<br>
   GunicornはPythonのアプリケーションをサーバーとして動かすためのツール。<br>
   Flask単体よりも安定して、同時に多くのリクエストを処理できるようになります。</p>

  <h5>App Engineにおける設定ファイルの場所</h5>
  <dl>
   <dt>dispatch.yaml はプロジェクトルート</dt>
   <dd>
    dispatch.yaml は、App Engine におけるサービス間のルーティング規則を定義するグローバルな設定ファイルです。<br>
    プロジェクト全体でどのリクエストをどのサービスに振り分けるかを決定するため、ルートディレクトリに配置され、一元管理されます。
   </dd>

   <dt>redirect.py は redirect-service ディレクトリ</dt>
   <dd>
    redirect.py は、リダイレクト専用の処理を実装しているため、メインサービスから分離して管理されます。<br>
    こうすればリダイレクト処理だけを担当する独立したサービス（redirect-service）として運用でき、メンテナンスやデプロイの際に柔軟性が向上します。
   </dd>

   <dt>app.yaml は各サービスごとに設置</dt>
   <dd>
    app.yamlについては既に書きましたが、改めて。<br>
    App Engine では、各サービスごとに個別の設定ファイル（app.yaml）が必要です。<br>
    プロジェクトのルートにある app.yaml はメインサービス用、redirect-service フォルダ内の app.yaml
    はリダイレクト専用サービス用となっており、それぞれのサービス固有の設定（ランタイムやスケーリングなど）を管理しています。
   </dd>

   <dt>requirements.txt も各サービスごとに設置</dt>
   <dd>
    各サービスは、それぞれ異なる依存関係を持つ可能性があります。<br>
    メインサービスとリダイレクトサービスで必要なライブラリが異なる場合、別々の requirements.txt を管理することで、各サービスごとに必要なパッケージのみをインストールでき、依存性管理が容易になります。
   </dd>
  </dl>

  <p>equirements.txt について特記するなら、各サービスは独立した環境としてデプロイされるため、同じ内容の requirements.txt をそれぞれのサービスのディレクトリに配置しても全く問題ありません。<br>
   App Engine
   はサービスごとに依存パッケージをインストールするので、メインサービスと redirect-service で同じライブラリ（Flask や gunicorn）を使っていても干渉しません。</p>

  <p>もし、コードや設定が共通している部分が多い場合、プロジェクト全体で管理する方法を工夫することも可能ですが…<br>
   シンプルな構成の場合は、各サービスディレクトリに同じ requirements.txt
   を用意するのが手間も少なく、一般的なアプローチだと思います。</p>

  <p class="codegra" id="redirect_app">リダイレクト設定を行うapp.yaml</p>
  <div class="code-container">
   <pre><code class="feintyping language-yaml">
runtime: python312
service: redirect-service

instance_class: F1
env: standard

automatic_scaling:
  min_idle_instances: 0
  max_idle_instances: 2
  max_concurrent_requests: 200

handlers:
- url: /(.*)
  script: auto

entrypoint: gunicorn -b :$PORT redirect:app

</code></pre>
  </div>

  <p>app.yaml は、Google App Engine (GAE) にアプリケーションをデプロイする際に必要な設定ファイルです。<br>
   このファイルには、アプリケーションの基本的な動作方法（ランタイムの種類、スケール方法、リクエスト処理の仕組みなど）が記述されています。</p>

  <ol>
   <li>この<span class="codecolor">app.yaml</span>をもとにGoogle App Engineがアプリケーションを設定します。</li>
   <li>必要に応じてインスタンスをスケールアップ／ダウンしてリソースを管理します。</li>
   <li>リクエストを受け取ると、Flaskアプリ（<span class="codecolor">redirect.py</span>）が動作して処理します。</li>
  </ol>

  <p><span class="small-orange-text">ただし、この設定は駆け出しサイト用です。<br>
    ある程度の規模になってくるとこれではアクセスを捌ききれないので、注意してください。</span></p>

  <p><strong>1. ランタイムとサービス名の設定</strong></p>
  <div class="code-container">
   <pre><code class="feintyping language-yaml">
runtime: python312
service: redirect-service

</code></pre>
  </div>

  <dl>
   <dt>runtime: python312</dt>
   <dd>アプリケーションを動かす環境を指定しています。<br>
    この場合、Pythonのバージョン<span class="codecolor">3.12</span>を使用します。</dd>

   <dt>service: redirect-service</dt>
   <dd>このアプリケーションのサービス名を指定しています。<br>
    「redirect-service」という名前のサービスとして動作します。</dd>
   <dd>サービス名とは、同じプロジェクト内で複数の機能を分けるために使用される「名前」です。</dd>
  </dl>

  <p><strong>2. インスタンスの設定</strong></p>
  <div class="code-container">
   <pre><code class="feintyping language-yaml">
instance_class: F1
env: standard

</code></pre>
  </div>

  <dl>
   <dt>instance_class: F1</dt>
   <dd>インスタンス（サーバー）のスペックを指定します。<span class="codecolor">F1</span>は、低コストの小規模なインスタンスで、軽量なアプリケーションに適しています。</dd>

   <dt>env: standard</dt>
   <dd>環境（エンジンの種類）を「Standard Environment」に設定。これは短時間の実行や軽い負荷向けの環境です。</dd>
  </dl>

  <p><strong>3. 自動スケーリングの設定</strong></p>
  <div class="code-container">
   <pre><code class="feintyping language-yaml">
automatic_scaling:
min_idle_instances: 0
max_idle_instances: 2
max_concurrent_requests: 200

</code></pre>
  </div>

  <dl>
   <dt>min_idle_instances: 0</dt>
   <dd>必要がないときはインスタンス（サーバー）を0個にしてコストを削減。</dd>

   <dt>max_idle_instances: 2</dt>
   <dd>アイドル状態でも最大2個のインスタンスを維持して、迅速にリクエストに応答。</dd>

   <dt>max_concurrent_requests: 200</dt>
   <dd>1つのインスタンスで同時に処理できるリクエスト数を最大200に設定。</dd>
  </dl>

  <p><strong>4. ハンドラー（リクエストのルール）</strong></p>
  <div class="code-container">
   <pre><code class="feintyping language-yaml">
handlers:
- url: /(.*)
script: auto

</code></pre>
  </div>

  <dl>
   <dt>url: /(.*)</dt>
   <dd>すべてのリクエスト（例: <span class="codecolor">/about</span>, <span class="codecolor">/contact</span> など）を対象としています。</dd>
   <dd><span class="codecolor">/(.*)</span> は「すべてのURL」を意味する正規表現です。</dd>

   <dt>script: auto</dt>
   <dd>Pythonランタイム環境で自動的にリクエストを処理。</dd>
  </dl>

  <p><strong>5. 実行エントリポイントの設定</strong></p>
  <div class="code-container">
   <pre><code class="feintyping language-yaml">
entrypoint: gunicorn -b :$PORT redirect:app

</code></pre>
  </div>
  <dl>
   <dt>entrypoint</dt>
   <dd>アプリケーションを実行するコマンドを指定します。</dd>

   <dt>gunicorn -b :$PORT redirect:app</dt>
   <dd><span class="codecolor">gunicorn</span>を使ってアプリケーションを実行。</dd>
   <dd><span class="codecolor">-b :$PORT</span>: 環境変数からポート番号を取得して接続。</dd>
   <dd><span class="codecolor">redirect:app</span>: <span
     class="codecolor">redirect.py</span>ファイルの中にあるFlaskアプリケーション（<span class="codecolor">app</span>）を実行。</dd>
  </dl>

  <p>このファイルは、アプリの「設定表」や「設計図」のようなものですよね。<br>
   間違った設定をするとアプリが正常に動かないこともあるため、細かい部分まで慎重に作成する必要があります。</p>

  <h5>リダイレクト専用の動作を完全に分離する</h5>
  <p>リダイレクト設定を一つの app.yaml に書き足すだけで済むケースだってあります。<br>
   app.yaml は、App Engineサービス全体の設定ファイルであり、アプリケーションの動作環境、すなわちランタイムやエントリポイント、URLマッピングを定義します。<br>
   ここでリダイレクト設定を app.yaml の一部に統合しようとすると、メインアプリ（静的ウェブサイトやFlaskアプリ）の動作と混ざり合ってしまって、平たく言うとややこしいんですよ…</p>

  <p>リダイレクト設定があると、/ やその他のルートへのリクエストをリダイレクト用のロジックが処理してしまい、メインのアプリケーションに到達できなくなる可能性があります。<br>
   https://feinatelier.org/top のアクセスがリダイレクト設定に奪われるとか。<br>
   こういうのを、URLパスの競合と言います。</p>

  <p>そもそもリダイレクトは独自の振る舞いが求められるケースが多く、例えば301リダイレクトのHTTPステータスを正確に返す必要があります。<br>
   リダイレクトの独立性を損なうようなプロジェクト構成の設計は、望ましくないです。<br>
   一方、メインアプリではHTMLや動的コンテンツの提供が優先されるため、同じ app.yaml 内でロジックが混在すると管理が煩雑になります。</p>

  <p>現在のように、<span class="codecolor">redirect.py</span>を<span
    class="codecolor">redirect-service</span>ディレクトリに独立させて別のサービスとしてデプロイするアプローチは、App Engineの<span
    class="codecolor">マイクロサービス設計</span>に適合しています。</p>

  <p>App Engineでは、複数のサービスを<span class="codecolor">dispatch.yaml</span>でルーティングできます。<br>
   すると、次のように役割を完全に分離した設計が可能になるんです。</p>

  <dl>
   <dt>メインサービス</dt>
   <dd>
    <span class="codecolor">main.py</span> 静的ウェブサイトや動的コンテンツを提供。
   </dd>

   <dt>リダイレクトサービス</dt>
   <dd>
    <span class="codecolor">redirect.py</span> すべてのリクエストを新しいURL <span class="codecolor">feinatelier.org</span>
    に301リダイレクト。
   </dd>
  </dl>

  <p>こうすることで、互いの振る舞いが影響を与えることなく、独立して動作させることができます。<br>
   リダイレクト設定を一つの app.yaml に書き足すだけで済むケースというのは、ルート数が少なく、振る舞いが単純な場合ですよね。<br>
   特定のページだけ別のURLへ飛ばすとか。<br>
   でも今回のようにプロジェクト構成へ丸ごと独自ドメインを適用するようなケースでは、あまり適切とは言えないでしょう。<br>
   現在のアプローチが優れている理由としては、次の3点が挙げられます。</p>

  <ol>
   <li>リダイレクト処理を完全に独立させて管理できる。</li>
   <li>URLの競合を避け、役割を明確に分離できる。</li>
   <li><span class="codecolor">dispatch.yaml</span>を使うことで柔軟なサービス間ルーティングが可能。</li>
  </ol>

  <p>つまり、今後を見据えた柔軟性と保守性を重視して、この設計にしているわけです。</p>

  <h4>App Engineへリダイレクト設定をデプロイ</h4>
  <p>さて、ここまで書けたら、App Engineへのデプロイしましょう。</p>
  <p>リダイレクト専用サービスのフォルダ redirect-service へ移動してデプロイしてください。</p>
  <div class="code-container">
   <pre><code class="feintyping language-bash">
$ gcloud app deploy app.yaml

</code></pre>
  </div>

  <p>次はプロジェクトのルートへ移動してから、そこに配置した dispatch.yaml をデプロイします。</p>
  <div class="code-container">
   <pre><code class="feintyping language-bash">
$ gcloud app deploy dispatch.yaml

</code></pre>
  </div>

  <p>メインサービスはこれまで通り、プロジェクトルートでgcloud app deployをするのみです。</p>

  <h5>gcloud app deploy コマンドの注意点</h5>
  <p>プロジェクトルートで普通にWebサイトを更新する時には、<span class="codecolor">gcloud app deploy</span>コマンドに「<span
    class="codecolor">app.yaml</span>」をつけなくても良いのですよ？<br>
   プロジェクトルートにある<span class="codecolor">app.yaml</span>を暗黙的に使うため、明示的にファイル名を書く必要がないからです。</p>

  <p><span class="codecolor">gcloud app deploy</span>コマンドは、現在のディレクトリに<span
    class="codecolor">app.yaml</span>が存在する場合、自動的にそのファイルを認識して使用します。<br>
   つまり、プロジェクトのルートに<span class="codecolor">app.yaml</span>が配置されている状態で<span class="codecolor">gcloud app
    deploy</span>とだけ入力すれば、明示的にファイル名を指定しなくてもデプロイが実行されます。</p>

  <p>一方で、リダイレクト専用サービスの場合は、フォルダ<span class="codecolor">redirect-service</span>内の<span
    class="codecolor">app.yaml</span>をデプロイするため、フォルダに移動するか明示的にファイルパスを指定する必要があります。<br>
   そのため、次のような手順となっているのです。</p>

  <dl>
   <dt><span class="codecolor">redirect-service</span>ディレクトリへ移動してデプロイ。</dt>
   <dd><span class="codecolor">gcloud app deploy app.yaml</span></dd>

   <dt>プロジェクトルートに移動して<span class="codecolor">dispatch.yaml</span>をデプロイ。</dt>
   <dd><span class="codecolor">gcloud app deploy dispatch.yaml</span></dd>

   <dt>メインサービス（ルートの<span class="codecolor">app.yaml</span>）のデプロイでは、ファイル指定が不要。</dt>
   <dd><span class="codecolor">gcloud app deploy</span></dd>
  </dl>

  <p>このサイトでは現在、<span class="codecolor">app.yaml</span> 内で静的ハンドラとして <span class="codecolor">www/</span>
   以下のコンテンツを配信していますが、デフォルト URL でのアクセスは本ディスパッチ設定によりリダイレクト対象になるため、静的ファイルも自動的に独自ドメインに誘導されるのですよ。</p>

  <p>以上が、このサイトに合わせた「<span class="codecolor">App Engine</span> のサービス／ディスパッチ設定でリダイレクトする方法」のソースコード解説になります。<br>
   これで <span class="codecolor">https://fein-sites-dev1.ew.r.appspot.com/</span> へアクセスしたユーザーは自動的に <span
    class="codecolor">https://feinatelier.org/</span> へリダイレクトされるってことですね。</p>

  <h4>リダイレクトのテストと検証</h4>
  <p>Twitterなどでフォロワーさんに「古いURLでアクセスしてみて!」などと、負荷をかけるようなことをしてはいけません。<br>
   デプロイ後は、ログなどでリダイレクトが正しく実施されているかを自分で確認しましょう。</p>

  <div class="code-container">
   <pre><code class="feintyping language-bash">
$ gcloud app services list

SERVICE NUM_VERSIONS
default 167
redirect-service 1

</code></pre>
  </div>

  これは、App Engine プロジェクト内に2つのサービスが存在することを意味しています。
  それぞれの行は、サービス名とそのサービスに展開されているバージョンの数を表しています。

  <dl>
   <dt>default</dt>
   <dd>メインのサービスです。<br>
    ここでは <strong>167</strong> 個のバージョンが存在しており、これまでのデプロイ履歴（過去のバージョンも残っている状態）が反映されています。</dd>

   <dt>redirect-service</dt>
   <dd>リダイレクト専用サービスです。<br>
    ここには <strong>1</strong> 個のバージョンが存在しているので、最新（そして唯一）のバージョンがデプロイされていることが分かります。</dd>
  </dl>

  <p>これが私の検証だとするなら、redirect-service は正常にデプロイされていて、ルーティング設定（dispatch.yaml）によって <span
    class="codecolor">https://fein-sites-dev1.ew.r.appspot.com/</span>
   へのアクセスがこのサービスに振り分けられているのです。<br>
   設定は正しく反映されていると考えて良いでしょう。</p>

  <p>仮に、ここで「Service Unavailable」などのエラーがブラウザに表示される場合は、リダイレクトサービスのログを確認して、エラーが発生していないかチェックする必要があります。<br>
   例えば、以下のコマンドでリアルタイムのログを確認できます。</p>

  <div class="code-container">
   <pre><code class="feintyping language-bash">
$ gcloud app logs tail -s redirect-service

</code></pre>
  </div>

  <p>redirect-service のエラー内容や動作状況を詳しく把握して、調べてみましょう。<br>
   また、次のようにコマンドラインでも、リダイレクトが正しく機能しているか検証できます。</p>

  <h5>cURL でヘッダーを確認する</h5>
  <p>cURL（カール）は、データをURL経由でやり取りするためのコマンドラインツールです。<br>
   主にWeb開発やネットワーク管理で使用され、HTTPやHTTPSなどのプロトコルを通じてリクエストを送信し、その応答を確認することができます。<br>
   たとえば、「ヘッダーを確認する」という場合、cURLを使うと簡単にHTTPリクエストやレスポンスのヘッダー情報を取得できます。<br>
   ここで、あるURL https://example.com のヘッダー情報を取得してみましょう。</p>

  <div class="code-container">
   <pre><code class="feintyping language-bash">
$ curl -I https://example.com

</code></pre>
  </div>
  <p>このコマンドの結果として、レスポンスのヘッダー情報（例：HTTPステータス、サーバー情報、コンテンツタイプなど）が表示されます。<br>
   これを独自ドメインのリダイレクト設定チェックに使うなら、次のようにターミナルやコマンドプロンプトから以下のコマンドを実行します。</p>

  <div class="code-container">
   <pre><code class="feintyping language-bash">
$ curl -I https://fein-sites-dev1.ew.r.appspot.com/

HTTP/1.1 301 Moved Permanently
Location: https://feinatelier.org/

</code></pre>
  </div>
  <p>HTTP レスポンスのヘッダー情報だけが表示されます。─ 実際にはもっといろいろ出ますよ？ ─<br>
   このように、Location ヘッダーにリダイレクト先の URL が記載されていること、また 301 ステータスが返っていることを確認してください。<br>
   この方法でリダイレクトが正しく設定され、<span class="codecolor">https://fein-sites-dev1.ew.r.appspot.com/</span> から <span
    class="codecolor">https://feinatelier.org/</span> に転送されていることを確かめることができます。</p>


  <!-- ●ここから人間用のフッター● -->
  <hr id="feinhr">
  <div class="spacer"></div>

  <section class="sitemap">
   <h2 class="sitemap_heading">サイトマップ</h2>
   <p><a href="/pages/pagelist">全ページをリスト化したサイトマップ</a>も用意していますが、けっこうなページ数があります。<br>
    下記の「カテゴリー分けサイトマップ」のほうが使いやすいでしょう。</p>
   <p><a href="/another-eden/anaden_sitemap.html">
     アナザーエデン関連ページ・サイトマップ</a><br>
    アナザーエデンの強敵戦やストーリーコンテンツのリスト、お勧めバッジなどを掲載したコーナーです。<br>
    期間限定のない普通のRPGですので、初心者でも安心して続けていけるゲームとなっています。<br>
    もっとも重要なグラスタについては、場所別に網羅した表があります。</p>


   <p><a href="/contents/site_create.html">
     個人サイトのホスティングとコンテンツ作成</a><br>
    個人でウェブサイトを作るなら時間をかけて。<br>
    HTML・CSS・JavaScriptの書き方はもちろん、無料かつ広告なしでホームページを作る方法を掲載したコーナーです。<br>
    Webデザインやレイアウトについても書いてあります。</p>
   <p><a href="/fish/fish_sitemap.html">魚釣りなどアウトドアのエリア</a><br>
    ゲームとパソコンだけじゃなく、アウトドアも趣味なんです。<br>
    このコーナーでは魚釣りの記録とか、魚料理のレシピ、はたまたサイクリングなどなど。<br>
    アウトドアに関連するコンテンツが詰め込まれています。</p>

  </section>

  <!-- ページ上部へ戻るボタン -->
  <button id="scrollToTopBtn" onclick="scrollToTop()">ページ上部へ戻る</button>
  <script src="{{ url_for('static', filename='js/feinScroll.js') }}"></script>

  <div class="spacer"></div>

  <footer>
   <!--common google digital leader-->

   <div id="commongdl"></div>
   <script src="{{ url_for('static', filename='externalization/common.js') }}"></script>

   <div class="spacer"></div>


   <div class="spacer"></div>
   <p class="portal" id="updated-date">この <a href="https://feinatelier.org/">fein's personal
     site</a> は、2023/7/4に開設された <a href="https://portal.feinatelier.org/">fein's portal</a>
    を母体として、yyyy/mm/ddに至るまで更新し続けられています。</p>
   <script>
    document.addEventListener('DOMContentLoaded', function () {
     const today = new Date();
     const year = today.getFullYear();
     const month = String(today.getMonth() + 1).padStart(2, '0');
     const day = String(today.getDate()).padStart(2, '0');
     const dateElement = document.getElementById('updated-date');
     dateElement.innerHTML = `この <a href="https://feinatelier.org/">Fein Atelier - org</a> は、2023/7/4に開設された <a href="https://portal.feinatelier.org/">fein's portal</a> を母体として、${year}/${month}/${day}に至るまで更新し続けられています。`;
    });
   </script>

  </footer>

 </div><!--レスポンシブデザイン-->

 <script src="{{ url_for('static', filename='js/feinheadline1.js') }}"></script><!--見出しの自動生成-->

 <!-- ●ここまで人間用のフッター。直下でbodyを閉める● -->
</body>

</html>
